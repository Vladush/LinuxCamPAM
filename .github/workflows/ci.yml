name: CI

on:
  push:
    branches: [master]
    tags: ["v*.*.*"]
  pull_request:
    branches: [master]

jobs:
  build-gcc:
    name: Build (GCC)
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake libopencv-dev libpam0g-dev \
            libjsoncpp-dev nlohmann-json3-dev v4l-utils \
            libgtest-dev devscripts debhelper dh-cmake

      - name: Download models
        run: ./scripts/download_models.sh

      - name: Configure
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build -j$(nproc)

      - name: Test
        run: ctest --test-dir build --output-on-failure

      - name: Build package
        run: |
          dpkg-buildpackage -b -uc -us
          mv ../linuxcampam_*.deb .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linuxcampam-amd64-deb
          path: linuxcampam_*.deb
          retention-days: ${{ startsWith(github.ref, 'refs/tags/') && 90 || 7 }}

  build-clang:
    name: Build (Clang)
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake clang libopencv-dev libpam0g-dev \
            libjsoncpp-dev nlohmann-json3-dev v4l-utils

      - name: Configure
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++

      - name: Build
        run: cmake --build build -j$(nproc)

  build-aarch64:
    name: Build (aarch64)
    runs-on: ubuntu-24.04-arm # Native ARM runner - faster than QEMU
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake libopencv-dev libpam0g-dev \
            libjsoncpp-dev nlohmann-json3-dev v4l-utils \
            libgtest-dev devscripts debhelper dh-cmake

      - name: Download models
        run: ./scripts/download_models.sh

      - name: Configure
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build -j$(nproc)

      - name: Test
        run: ctest --test-dir build --output-on-failure

      - name: Build package
        run: |
          dpkg-buildpackage -b -uc -us
          mv ../linuxcampam_*.deb .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linuxcampam-aarch64-deb
          path: linuxcampam_*.deb
          retention-days: ${{ startsWith(github.ref, 'refs/tags/') && 90 || 7 }}

  build-i386:
    name: Build (i386)
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/386

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Download models
        run: ./scripts/download_models.sh

      - name: Build i386
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile.i386
          platforms: linux/386
          load: true
          tags: linuxcampam:i386
          cache-from: type=gha,scope=i386
          cache-to: type=gha,mode=max,scope=i386

      - name: Extract artifacts
        run: |
          docker create --name temp_container linuxcampam:i386
          DEB_FILE=$(docker cp temp_container:/ - | tar -tf - | grep '\.deb$' | head -1)
          docker cp "temp_container:/$DEB_FILE" .
          docker rm temp_container

      - name: Verify
        run: docker run --rm --platform linux/386 --entrypoint /usr/bin/linuxcampam linuxcampam:i386 help

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linuxcampam-i386-deb
          path: linuxcampam_*.deb
          retention-days: ${{ startsWith(github.ref, 'refs/tags/') && 90 || 7 }}

  build-riscv64:
    name: Build (riscv64)
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/riscv64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Download models
        run: ./scripts/download_models.sh

      - name: Build riscv64
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile.riscv64
          platforms: linux/riscv64
          load: true
          tags: linuxcampam:riscv64
          cache-from: type=gha,scope=riscv64
          cache-to: type=gha,mode=max,scope=riscv64

      - name: Extract artifacts
        run: |
          docker create --name temp_container linuxcampam:riscv64
          DEB_FILE=$(docker cp temp_container:/ - | tar -tf - | grep '\.deb$' | head -1)
          docker cp "temp_container:/$DEB_FILE" .
          docker rm temp_container

      - name: Verify
        run: docker run --rm --platform linux/riscv64 --entrypoint /usr/bin/linuxcampam linuxcampam:riscv64 help

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linuxcampam-riscv64-deb
          path: linuxcampam_*.deb
          retention-days: ${{ startsWith(github.ref, 'refs/tags/') && 90 || 7 }}
